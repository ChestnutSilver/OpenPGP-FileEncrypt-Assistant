# 一、软件设计文档

[TOC]

#### 0. 写在前面

##### 0.1 小组分工情况：

| 学号    | 姓名   | 分工                 | 贡献度 |
| ------- | ------ | -------------------- | ------ |
| 2053182 | 王润霖 | 模块一、四、UI设计   | 50.00% |
| 2052338 | 鲍宇轩 | 模块二、三、报告撰写 | 50.00% |

模块划分详见我们的软件（文件三）。

##### 0.2 任务完成情况

我们按照目前掌握的知识，完成了**100%的所有任务**！

我们将软件**完整封装**，解压后即可运行！

我们的代码经过**11次版本迭代**，迭代版本（1.3、1.4、1.5、1.6、1.7、1.8、2.0）和最终版代码（3.0），都可在：https://github.com/ChestnutSilver/OpenPGP-FileEncrypt-Assistant

##### 0.3 原创性说明

我们的代码是**逐行编写**的，这保证了**100%的原创性**（包括UI的配色方案在内）。

具体第三方资源使用，见文件五。

---

#### 1. 需求分析

##### 1.1 功能需求

**1. 存储者**
①通过自己的ID和Passphrase登陆
②单人模式，通过真实性认证，加密签名后文件仅自己可以调阅
③多人模式，通过真实性认证，授权指定用户调阅加密签名后文件

**2. 调阅者**
①通过自己的ID和Passphrase登陆
②可通过真实性认证，调阅解密被授权文件

**3. 其他非授权用户**
①通过自己的ID和Passphrase登陆
②不可通过身份验证，无法以可理解的方式读出文件内容

**4. 系统管理员** 
①直接通过系统生成对应的ID和Passphrase
②进行操作前仍需通过ID和Passphrase登录
③调阅也需授权，无特殊权限

**5. 敏感信息覆盖**

解决方案：Windows API GetFileMapping + SecureZeroMemory。

我们通过 `CreateFile` 打开了指定目录下的 `a.txt` 文件，并得到了一个文件句柄 `hFile`。然后，我们使用 `CreateFileMapping` 对该文件进行映射，并得到了一个文件映射句柄 `hMapFile`。接下来，我们使用 `MapViewOfFile` 将文件映射到进程的地址空间中，并获得了指向该映射区域的指针 `lpMapView`。最后，我们可以通过访问 `lpMapView` 指向的内存区域，从而读取到该文件的内容。使用`SecureZeroMemory`函数被用来覆盖文件映射的地址空间。在程序结束时，我们调用 `UnmapViewOfFile`、`CloseHandle` 函数分别释放内存和关闭相关句柄，避免资源泄露。

#### 2. 流程设计

##### 2.1 环境声明

2.1.1 运行环境
系统：Windows 10
软件：Visual Studio 2019  (x86 Debug模式)
库：IPWorks OpenPGP 2022 C++ Edition

2.1.2 调试环境
系统：Windows 10
软件：Visual Studio 2019  (x86 Debug模式)
库：IPWorks OpenPGP 2022 C++ Edition

##### 2.2 功能

2.2.1原理展示
目标：展现用户通过密钥签名加密和解密验证字符串的过程
步骤：①输入待加密字符串  
      ②通过用户私钥签名，公钥加密后输出处理后字符串
      ③通过用户私钥解密，公钥验证签名后输出解密后字符串               

2.2.2存储功能
2.2.2.1单用户授权
目标：A 用户想要存储自己的文件，并仅自己拥有调阅权限。 
步骤：①输入待加密文件路径
      ②通过A用户私钥签名，A用户公钥加密后保存为.gpg文件
2.2.2.2多用户授权
目标：A 用户想要存储自己的文件，并使 B 用户都拥有调阅权限。 
步骤：①设置授权用户B
      ②输入待加密文件路径
      ③通过A用户私钥签名，B用户公钥加密后保存为.gpg文件

2.2.3调阅功能
目标：A 用户调阅以.gpg 后缀结尾的文件。 
步骤：①输入待调阅文件
      ②A用户用自己的私钥解密文件，用公钥库中的公钥对文件中的签名进行验证，如果验证成功，则输出文件及创建者（签名者）的身份

##### 2.3 初始状态

2.3.1存储路径默认
输出文件：D:\OpenPGP_File_Manage_show\username\File
密钥相关：D:\OpenPGP_File_Manage_show\username\Key
keyring相关：D:\OpenPGP_File_Manage_show\username\Key\key-store
ps:其中username会据情况变化
2.3.2用户初始状态
均无相关权限，系统用户默认登陆

#### 3. 组件关系及其调用

主要由user、gloabl、FileManage、KeyManage、ModeManage五个类组成，还包括库中含有的KeyMgr、OpenPGP等。

![image-20230421193836296](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421193836296.png) 

####  4. 概要与详细设计

##### 4.1 组成模块

该程序由用户模块、全局文件存储模块、密钥管理模块、模式选择响应模块、文件/字符串处理模块组成。

##### 4.2 各模块功能及函数声明约定

**4.2.1用户模块**
功能：获取当前用户信息，储存用户名、用户安全标识符、授权用户ID，并提供获取相应值的函数。
对应函数声明如下：
void currentUserInfo();
string getUsername();
PSID getSid();
LPWSTR getStringSid();
    string getUserID();

**4.2.2 全局文件存储模块**
功能：设置文件存储目录。其中包含路径合并、创建文件夹、获取当前用户子功能。
对应函数声明如下：
void set_baseName();
string conbineStrings(string left, string right);//返回合并后路径
int createDirectoryByString(string path);
string globalGetUserName();//返回username

**4.2.3 密钥管理模块**
功能：生成密钥对，导出公钥，导出私钥，列出密钥情况（含userID、KeyID，但不含密钥具体信息）；其中还涉及密钥相关信息的初始化。
对应函数声明如下：
void GenerateKeyPairRSA(string userID, string pwd);
	void ExportPublicKey(string userID, string pwd);
	void ExportPrivateKey(string userID, string pwd);
	void KeyStoreListKeys(string pwd);
void init(Global global, User user);

**4.2.4 模式选择响应模块**
功能：选择模式，处理对应模式
对应函数声明如下：
int modeInput(Global global, User user);//返回选择模式对应数值
	void modeControl(int mode, User user, string pwd);

**4.2.5 文件/字符串处理模块**
功能：签名加密字符串，解密验证字符串，单用户模式下对文件的签名加密，多用户模式下对文件的签名加密，单用户模式下身份真实性验证，多用户（普通）情况下真实性验证（含揭秘过程）
对应函数声明如下：
void SignAndEncryptString(string pwd, string userID, string keyringDir);
	void DecryptAndVerifyString(string signedAndEncryptedMessage, string pwd, string userID);
	string SignAndEncryptSingle(string pwd, string filePath, string userID, string pathStringFile, string keyringDir);//返回加密后文件的路径
	string SignAndEncryptMultiple(string pwd, string filePath, string userID, string pathStringFile, string keyringDir); //返回加密后文件的路径
	bool VerifySingle(string pwd, string filePath, string userID, string pathStringFile, string keyringDir);//返回身份认证是否通过
	    bool Verify(string pwd, string filePath, string userID, string pathStringFile, string keyringDir); //返回身份认证是否通过

#### ![image-20230421194021555](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421194021555.png)

#### 5. 数据字典

##### 5.1 类的成员

**5.1.1 user**

class User

{

private:

  string username;		//用户名

  PSID sid;		//用户安全标识符

  LPWSTR stringSid;  //用户安全标识符，LPWSTR格式

  string userID;//当前用户ID

  vector<string> allUsers;//存授权ID，含当前用户

公共成员函数省略

}

**5.1.2 global**

class Global

{

public:

​	string baseName = "D:\\";

​	string folderName = "OpenPGP_File_Manage_show";

​	string folderName1 = "Key";

​	string folderName2 = "File";

 

​	string pathString;//总文件夹路径

​	string pathStringUser;//用户文件夹路径

​	string pathStringKey;//密钥存储文件夹路径

​	  string pathStringFile;//输出文件存储文件夹路径

公共成员函数省略

}

**5.1.3 keyManage**

  class MyKeyMgr : public KeyMgr

class KeyManage

{

private:

​	struct KeyGlobal {

​		string pathString; //总文件夹路径

​		string pathStringUser; //用户文件夹路径

​		string pathStringKey; //密钥存储文件夹路径

​		  string pathStringFile; //输出文件存储文件夹路径

​	}keyGlobal;//在KeyManage类中存储global相关信息

​	struct KeyUser {

​		string userID;//用户名

​	}keyUser; //在KeyManage类中存储user相关信息

​	MyKeyMgr keymgr;//用于调用库中与密钥相关函数

 

公共成员函数省略

}

**5.1.4 ModeManage**

class ModeManage

{

private:

​	struct ModeGlobal {

​		string pathString; //总文件夹路径

​		string pathStringUser; //用户文件夹路径

​	  	string pathStringKey; //密钥存储文件夹路径

​		string pathStringFile; //输出文件存储文件夹路径

​	 }modeGlobal; //在ModeManage类中存储global相关信息

 

公共成员函数省略

}

**5.1.5 FileManage**

class FileManage

{

private:

​	  char* Output;//存储加密或解密后的字符串

public:

​	struct ModeUserIDPwd {

​		  string modeUserID;//用户ID

​		  string modePwd;//用户密码

​	    }modeUserIDPwd;

公共成员函数省略

}

##### 5.2. 常用变量

//下面三个存储均为用户ID

char privateKey[LINE_LEN];//操作用户

char recipientKey[LINE_LEN];//接收者

char signerKey[LINE_LEN];//签名者/创建者

//下面两个存用户密码

char passphrase[LINE_LEN];

string pwd

//下面两个存的是keyring存放路径

char mykeyringDir[LINE_LEN];

string keyringDir

//存部分库函数返回值便于出错处理

int ret_code = 0;

#### 6. 编译手册

我们的源代码可在**Qt 5.12.0版本下编译**，这需要配置IPWorks OpenPGP库。

当然，可以**直接运行exe文件**进行测试。

#### 7. 安装手册

**解压缩即可运行**，详见“三、可执行安装包”。

#### 8. 自测用例、用户手册、测试分析报告、测试手册

详见“四、测试用例和分析报告”